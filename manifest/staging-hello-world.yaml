---
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-hw-staging
  namespace: gitlab
data:
  FLASK_CONFIG: "staging"
  DB_USER: "cnpnldjb"
  DB_PASS: "Yc4MicwfIrewPagGM5bQOoXQ_UMZahxn"
  DB_HOST: "elmer.db.elephantsql.com"
  DB_PORT: "5432"
  DB_NAME: "cnpnldjb"
  LOG_LEVEL: "INFO"
  LOG_FORMATTER: "TEXT"
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: hello-world-stg
  namespace: gitlab
  labels:
    app: hello-world-stg
    env: staging
spec:
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: hello-world-stg
        env: gitlab
    spec:
      containers:
        - name: hello-world-stg
          image: "registry.gitlab.com/hamsterwheel/hello-world:latest"
          imagePullPolicy: Always
          envFrom:
            - configMapRef:
                name: config-hw-staging
          ports:
            - containerPort: 5000
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/v1/status
              port: 5000
            initialDelaySeconds: 90
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /api/v1/status
              port: 5000
            timeoutSeconds: 1
          
      imagePullSecrets:
        - name: registrypullsecret-gl-hw
---
kind: Service
apiVersion: v1
metadata:
  labels:
    app: hello-world-stg
  name: hello-world-stg
  namespace: gitlab
spec:
  type: ClusterIP
  ports:
  - port: 5000
    name: http
  selector:
    app: hello-world-stg
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-gitlab-hw-staging
  namespace: gitlab
  annotations:
    kubernetes.io/ingress.class: "traefik"
    traefik.ingress.kubernetes.io/whitelist-source-range: "72.79.44.36/32,13.59.49.199/32,18.217.83.204/32,10.0.0.0/8,71.105.157.26/32"
spec:
  rules:
  - host: staging-hello-world.aoach.tools
    http:
      paths:
      - path: /
        backend:
            serviceName: hello-world-stg
            servicePort: 5000